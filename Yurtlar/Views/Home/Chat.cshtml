@model List<Yurtlar.Message>
@{
    ViewBag.Title = "Sohbet";
    var receiver = ViewBag.Receiver as Yurtlar.Users;
}

<h2>@receiver.Name @receiver.Surname ile Sohbet</h2>

<div id="chatWindow" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">
    @foreach (var msg in Model)
    {
        <div style="text-align:@(msg.SenderId == ViewBag.SenderId ? "right" : "left")">
            <b>@(msg.SenderId == ViewBag.SenderId ? "Siz" : receiver.Name):</b> @msg.Content
        </div>
    }
</div>

<textarea id="messageInput" rows="2" style="width: 100%;"></textarea>
<button id="sendBtn" type="button">Gönder</button>

@section scripts {
    <script src="~/Scripts/jquery-3.6.0.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <script src="/signalr/hubs"></script>

    <script>
        $(function () {
            var senderId = '@ViewBag.SenderId';
            var receiverId = '@ViewBag.ReceiverId';

            var chat = $.connection.chatHub;

            chat.client.receiveMessage = function (sender, message) {
                var align = sender === senderId ? 'right' : 'left';
                $('#chatWindow').append('<div style="text-align:' + align + '"><b>' + (sender === senderId ? 'Siz' : '@receiver.Name') + ':</b> ' + message + '</div>');
                $('#chatWindow').scrollTop($('#chatWindow')[0].scrollHeight);
            };

            $.connection.hub.qs = { 'userId': senderId }; // userId'yi gönder
            $.connection.hub.start().done(function () {
                $('#sendBtn').click(function () {
                    var message = $('#messageInput').val();
                    if (message.trim() !== '') {
                        chat.server.send(senderId, receiverId, message);
                        $('#messageInput').val('');
                        // AJAX ile DB’ye de kaydedelim
                        $.post('/Home/SendMessage', { senderId: senderId, receiverId: receiverId, content: message });
                    }
                });
            });
        });
    </script>
}
